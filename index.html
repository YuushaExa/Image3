<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Healing Spot Tool with Poisson Editing</title>
<style>
#canvas {
border: 1px solid black;
cursor: none;
}
.cursor {
position: absolute;
border-radius: 50%;
border: 2px solid red;
pointer-events: none;
display: none;
}
</style>
</head>
<body>
<input type="file" id="upload" accept="image/*">
<button id="healToolButton">Healing Spot Tool</button>
<label for="cursorSize">Cursor Size:</label>
<input type="range" id="cursorSize" min="5" max="100" value="20">
<label for="blendingIntensity">Blending Intensity:</label>
<input type="range" id="blendingIntensity" min="0.1" max="2" step="0.1" value="1">
<canvas id="canvas"></canvas>
<div id="cursor" class="cursor"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
const upload = document.getElementById('upload');
const healToolButton = document.getElementById('healToolButton');
const cursorSizeInput = document.getElementById('cursorSize');
const blendingIntensityInput = document.getElementById('blendingIntensity');
const canvas = document.getElementById('canvas');
const context = canvas.getContext('2d');
const cursor = document.getElementById('cursor');

let image = new Image();
let usingHealTool = false;
let cursorSize = parseInt(cursorSizeInput.value, 10);
let blendingIntensity = parseFloat(blendingIntensityInput.value);
let canvasData = null;

upload.addEventListener('change', handleImageUpload);
healToolButton.addEventListener('click', toggleHealTool);
cursorSizeInput.addEventListener('input', updateCursorSize);
blendingIntensityInput.addEventListener('input', updateBlendingIntensity);
canvas.addEventListener('mousemove', handleMouseMove);
canvas.addEventListener('click', handleCanvasClick);

function handleImageUpload(event) {
const file = event.target.files[0];
if (file) {
const reader = new FileReader();
reader.onload = function (e) {
image.onload = () => {
canvas.width = image.width;
canvas.height = image.height;
context.drawImage(image, 0, 0);
canvasData = context.getImageData(0, 0, canvas.width, canvas.height);
};
image.src = e.target.result;
};
reader.readAsDataURL(file);
}
}

function toggleHealTool() {
usingHealTool = !usingHealTool;
cursor.style.display = usingHealTool ? 'block' : 'none';
}

function updateCursorSize() {
cursorSize = parseInt(cursorSizeInput.value, 10);
cursor.style.width = cursor.style.height = `${cursorSize}px`;
}

function updateBlendingIntensity() {
blendingIntensity = parseFloat(blendingIntensityInput.value);
}

function handleMouseMove(event) {
if (usingHealTool) {
const rect = canvas.getBoundingClientRect();
const x = event.clientX - rect.left;
const y = event.clientY - rect.top;
cursor.style.left = `${event.clientX - cursorSize / 2}px`;
cursor.style.top = `${event.clientY - cursorSize / 2}px`;
}
}

function handleCanvasClick(event) {
if (usingHealTool) {
const rect = canvas.getBoundingClientRect();
const x = event.clientX - rect.left;
const y = event.clientY - rect.top;
inpaintSpot(x, y);
}
}

function inpaintSpot(x, y) {
const radius = cursorSize / 2;
                const imageData = context.getImageData(x - radius, y - radius, radius * 2, radius * 2);
                const data = imageData.data;
                const copyData = new Uint8ClampedArray(data);

                // Average the surrounding pixels for the inpainting area
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    const a = data[i + 3];

                    // Calculate average color of surrounding pixels
                    const avg = getSurroundingAverage(i, copyData, radius, radius, imageData.width, imageData.height);
                    data[i] = avg[0];
                    data[i + 1] = avg[1];
                    data[i + 2] = avg[2];
                    data[i + 3] = a; // Maintain original alpha
                }

                context.putImageData(imageData, x - radius, y - radius);
            }

            function getSurroundingAverage(index, data, width, height, imgWidth, imgHeight) {
                const x = (index / 4) % width;
                const y = Math.floor((index / 4) / width);
                let rTotal = 0, gTotal = 0, bTotal = 0, count = 0;

                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        const nx = x + dx;
                        const ny = y + dy;
                        if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                            const nIndex = ((ny * width) + nx) * 4;
                            rTotal += data[nIndex];
                            gTotal += data[nIndex + 1];
                            bTotal += data[nIndex + 2];
                            count++;
                        }
                    }
                }

                return [rTotal / count, gTotal / count, bTotal / count];
            }
        });
    </script>
</body>
</html>
